<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title>Calender View</title>
	<style>
	body{
		padding-bottom: 100px;
	}

	.day-wrapper {
		width: 1200px;
		height: 200px;
		margin: 10px auto;
		overflow-x: auto;
		overflow-y: hidden;
	}

	.hour-wrapper {
		width: 1200px;
		height: 800px;
		margin: 100px auto;
	}

	.block {
		display: inline-block;
		border:1px solid red;
	}

	.legends{
		width: 100px;
		height: 100%;
	}

	.hours{
		width: 800px;
		height: 100%;
	}

	.air {
		width: 150px;
		height: 100%;
	}

	.line{
		fill:none;
		stroke: orange;
		stroke-width: 1.5px;
	}

	.axis path,
	.axis line{
		fill:none;
		stroke:#000;
	}

	.dot {
		fill: none;
		stroke: steelblue;
		stroke-width: 2px;
	}

	.indicator{
		stroke: lightgrey;
		stroke-width: 3px;
	}

	.slider-indicator{
		stroke: black;
		stroke-width: 3px;
	}
	</style>
	<script src="../lib/d3.js"></script>
</head>
<body>

<h1>Lorem ipsum dolor sit amet.</h1>
<div class="day-wrapper"></div>
<div class="hour-wrapper">
	<div class="block legends"></div>
	<div class="block hours"></div>
	<div class="block air"></div>
</div>

<script>
	//TODO:year scale in calendar view, week scale
	//TODO: grid in line chart

	window.onload = function(){
		/**
		 *  general setting
		 */
		/* margins setting */
		var margin = {
			top:30,
			right:20,
			bottom:30,
			left:50
		};

		var width = 2000 - margin.left - margin.right;
		var height = 600 - margin.top - margin.bottom;
		var cellSize = 17;

		/* time formatter */
		var day = d3.time.format("%w");
		var week = d3.time.format("%U");
		var format = d3.time.format("%Y-%m-%d");
		var year = d3.time.format("%Y"); // to differentiate 2014,2015, avoid overlap
		var hourParser = d3.time.format("%H:%M:%S").parse; // format hourly data

		/* standards */
		var AQIStandard = [0,50,100,150,200,300,400,500]; // http://en.wikipedia.org/wiki/Air_quality_index#Mainland_China
		var AQIStandardColors = ['#00E400','#FFFF00','#FF7E00','#FF0000','#99004C','#7E0023','#65001c'];



		/* color scale */
		var colorScale = d3.scale.quantile()
				.domain(AQIStandard)
				.range(AQIStandardColors);


		/* initiate svg in blocks respectively */
		var svgDay = d3.select(".day-wrapper")
				.append("svg")
					.attr({
						"width": width,
						"height": height
					})
				.append("g")
					.attr("transform", "translate("+ margin.left + "," + margin.top + ")")


		var svgLegends = d3.select(".block.legends")
				.append("svg")
					.attr({
						"width": "100%",
						"height": "100%"
					})
				.append("g")
					.attr("transform", "translate("+ margin.left + "," + margin.top + ")")


		var svgHour = d3.select(".block.hours")
				.append("svg")
					.attr({
						"width": "100%",
						"height": "100%"
					})
				.append("g")
				.attr("transform", "translate("+ margin.left + "," + margin.top + ")");


		var svgAir = d3.select(".block.air")
				.append("svg")
				.attr({
					"width": "100%",
					"height": "100%"
				})
				.append("g")
				.attr("transform","translate(15,0)")



		/* load data */
		d3.csv("../data/airquality.csv", function(err,csv){
			/* reconstruct data */
			var data = d3.nest()
					.key(function(d){
						return d.DATE;
					})
					.entries(csv);

			data.forEach(function(d){

				var sum = 0;
				d.values.forEach(function(v){
					sum += Number(v.AQI);
				});
				d.average = Math.round(sum / d.values.length);
				d.max = d3.max(d.values, function(v){
					return +v.AQI;
				});
				d.min = d3.min(d.values, function(v){
					return +v.AQI;
				});
				d.key = format.parse(d.key)
			});

			/**
			 * add blocks in day svg, calendar view
			 * notice to avoid the overlap between years
			 */
			var rect = svgDay.selectAll(".day")
					.data(data)
					.enter()
					.append("rect")
					.attr("class","day")
					.attr({
						"width": cellSize,
						"height": cellSize,
						"x": function(d){
							// avoid overlap
							if(year(d.key) == "2014"){
								return (week(d.key) - week(new Date(2014,3,13))) * cellSize;
							}else {
								return ( (52 - week(new Date(2014,3,13))) + Number(week(d.key)) ) * cellSize;
							}
						},
						"y": function(d){
							return day(d.key) * cellSize;
						}
					})
					.style("fill", function(d){
						return colorScale(d.average);
					})
					.on("click", showHour);

			rect.append("title")
			.text(function(d){
				return format(d.key) + " average AQI is " +  d.average;
			});


			/**
			 * initiate hourly data (line + scatterplot) in hour chart with the first data point
			 */
			var hourHeight = parseInt(d3.select(".hours").style("height"))/1.5;
			var hourWidth = parseInt(d3.select(".hours").style("width")) - margin.left - margin.right;


			var xScale = d3.time.scale()
								.domain([hourParser("00:00:00"),hourParser("23:00:00")])
								.range([0, hourWidth]);
								// https://www.google.com/webhp?sourceid=chrome-instant&ion=1&espv=2&ie=UTF-8#q=js%20string%20to%20number

			var yScale = d3.scale.linear()
			.domain([0,510]) // in this case, y domain is fixed as described in standards
			.range([hourHeight, 0]);

			var xAxis = d3.svg.axis()
									.scale(xScale)
									.orient("bottom")
									.tickFormat(d3.time.format("%H"))
									.ticks(24);

			var yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left")
					.tickValues(AQIStandard);
			// line generator
			var lineGenerator = d3.svg.line()
						.x(function(d){
							return xScale(hourParser(d.TIME))
						})
						.y(function(d){
							return yScale(Number(d.AQI))
						});

			var line = svgHour.append("path")// there is only one line, no need to data()
								.attr("d", lineGenerator(data[0].values))
								.attr("class","line");

			var xLineAxis = svgHour.append("g")
				.attr("transform","translate(0," + parseInt(d3.select(".hours").style("height"))/1.5 + ")")
				.attr("class","x axis")
				.call(xAxis);

			var yLineAxis = svgHour.append("g")
									.attr("class","y axis")
									.call(yAxis);

			// draw scatterplots
			var dots = svgHour.selectAll(".dot")
					.data(data[0].values, function(d){
						return d.TIME; // update binding by key, otherwise the selection is incorrect while updating new data
					})
					.enter()
					.append("circle")
					.attr({
						"cx": function(d){
							return xScale(hourParser(d.TIME))
						},
						"cy": function(d){
							return yScale(+d.AQI);
						},
						"r": 5
					})
					.attr("class","dot")
					.on("mouseenter", dotEnter)
					.on("mouseleave", dotLeave)
					.on("click", dotClick);

			/**
			 *  add legends in svgLegends correspondent with yAxis in line chart
			 *
			 */
			svgLegends.append("g")
					.selectAll(".legend")
					.data(colorScale.range())
					.enter()
					.append("rect")
					.attr({
						"x":30,
						"y":function(d,i){
							if(i == (AQIStandard.length-1)){
								return 0
							}else {
								return yScale(AQIStandard[i+1])
							}
						},
						"height":function(d,i){
							if(i == (AQIStandard.length-1)){
								return yScale(AQIStandard[i])
							}else {
								return yScale(AQIStandard[i]) - yScale(AQIStandard[i+1])
							}
						},
						"width":cellSize
					})
					.attr("class","legend")
					.style("fill", function(d,i){
						return d;
					});


			/**
			 * add sliders in svgAir to response to scatterplots in svgHour
			 */

			/* standards for each substance in the air */
			var so2 = [0,50,150,475,800,1600,2100,2620]; // so2 average in last 24 hours
			var no2 = [0,40,80,180,280,565,750,940]; // no2 average in last 24 hours
			var pm10 = [0,50,150,250,350,420,500,600]; // pm10 average in last 24 hours
			var co = [0,2,4,14,24,36,48,60]; // co average in last 24 hours
			var o3 = [0,160,200,300,400,800,1000,1200]; // calculation for o3 is average in last 1 hour
			var pm25 = [0,35,75,115,150,250,350,500]; // pm2.5 average in last 24 hours

			// add a chart for air detail
			// the standards for each substance are different from each other
			var sliderScale = d3.scale.linear()
					.range(d3.range(0, cellSize*9, cellSize));
			/**
			 *  scales for each substance
			 */

			var so2Scale = colorScale
					.domain(so2)
					.copy();

			var slider_so2 = sliderScale
					.domain(so2)
					.copy();

			var no2Scale = colorScale
					.domain(no2)
					.copy();

			var slider_no2 = sliderScale
							.domain(no2)
							.copy();

			var pm10Scale = colorScale
					.domain(pm10)
					.copy();

			var slider_pm10 = sliderScale
						.domain(pm10)
						.copy();

			var coScale = colorScale
					.domain(co)
					.copy();

			var slider_co = sliderScale
					.domain(co)
					.copy();

			var o3Scale = colorScale
					.domain(o3)
					.copy();
			var slider_o3 = sliderScale
					.domain(o3)
					.copy();

			var pm25Scale = colorScale
					.domain(pm25)
					.copy();
			var slider_pm25 = sliderScale
					.domain(pm25)
					.copy();

			/* append each air substance slider to svgAir*/

			var so2Slider = svgAir.append("g")
					.attr("transform","translate(0,30)")
					.attr("class","slider so2")

			var no2Slider = svgAir.append("g")
					.attr("transform","translate(0,60)")
					.attr("class","slider no2")

			var pm10Slider = svgAir.append("g")
					.attr("transform","translate(0,90)")
					.attr("class","slider pm10")

			var coSlider = svgAir.append("g")
					.attr("transform","translate(0,120)")
					.attr("class","slider co")

			var o3Slider = svgAir.append("g")
					.attr("transform","translate(0,150)")
					.attr("class","slider o3")

			var pm25Slider = svgAir.append("g")
					.attr("transform","translate(0,180)")
					.attr("class","slider pm25")

			/**
			 * add and initiate indicator for each slider
			 */

			// TODO:reuse?

			// so2
			so2Slider.selectAll(".slider-legend")
					.data(so2Scale.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			var sliderIndicator_so2 = so2Slider.append("g")
														.attr("class","slider-indicator")
														.attr("transform","translate(0,-5)")

			sliderIndicator_so2.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":23
					})

			sliderIndicator_so2.append("path")
			.attr("d", d3.svg.symbol().type("triangle-down"))


			// no2
			no2Slider.selectAll(".slider-legend")
					.data(no2Scale.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			var sliderIndicator_no2 = no2Slider.append("g")
														.attr("class","slider-indicator")
														.attr("transform","translate(0,-5)")

			sliderIndicator_no2.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":23
					})

			sliderIndicator_no2.append("path")
			.attr("d", d3.svg.symbol().type("triangle-down"))


			//pm10
			pm10Slider.selectAll(".slider-legend")
					.data(pm10Scale.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			var sliderIndicator_pm10 = pm10Slider.append("g")
														.attr("class","slider-indicator")
														.attr("transform","translate(0,-5)")

			sliderIndicator_pm10.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":23
					})

			sliderIndicator_pm10.append("path")
			.attr("d", d3.svg.symbol().type("triangle-down"))


			//co
			coSlider.selectAll(".slider-legend")
					.data(coScale.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			var sliderIndicator_co = coSlider.append("g")
														.attr("class","slider-indicator")
														.attr("transform","translate(0,-5)")

			sliderIndicator_co.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":23
					})

			sliderIndicator_co.append("path")
			.attr("d", d3.svg.symbol().type("triangle-down"))

			//o3
			o3Slider.selectAll(".slider-legend")
					.data(o3Scale.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			var sliderIndicator_o3 = o3Slider.append("g")
														.attr("class","slider-indicator")
														.attr("transform","translate(0,-5)")

			sliderIndicator_o3.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":23
					})

			sliderIndicator_o3.append("path")
			.attr("d", d3.svg.symbol().type("triangle-down"))

			//pm25
			pm25Slider.selectAll(".slider-legend")
					.data(pm25Scale.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			var sliderIndicator_pm25 = pm25Slider.append("g")
														.attr("class","slider-indicator")
														.attr("transform","translate(0,-5)")

			sliderIndicator_pm25.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":23
					})

			sliderIndicator_pm25.append("path")
			.attr("d", d3.svg.symbol().type("triangle-down"))


			/**
			 * event handlers
			 */

			function showHour(newData){
				console.log(newData)

				line.transition()
				.duration(1000)
					.attr("d", lineGenerator(newData.values));

				// dots transition
				/* handle update, enter, exit selection*/
				var selectedHour = svgHour.selectAll(".dot")
						.data(newData.values, function(d){
							return d.TIME;
						});

				selectedHour.transition()
				.duration(1000)
				.delay(200)
				.attr({
					"cx": function(d){
						return xScale(hourParser(d.TIME))
					},
					"cy": function(d){
						return yScale(+d.AQI);
					}
				});

				selectedHour.exit().transition()
				.remove();

				selectedHour.enter()
				.append("circle")
				.attr("class","dot")

			};

			// hover on dots to toggle indication lines
			function dotEnter(data){
				svgHour.append("line")
						.attr({
							"x1":0,
							"x2":function(d){
								return xScale(hourParser(data.TIME));
							},
							"y1":function(d){
								return yScale(+data.AQI);
							},
							"y2":function(d){
								return yScale(+data.AQI);
							}
						})
						.attr("class","indicator indicator-x");

				svgHour.append("line")
						.attr({
							"x1":function(d){
								return xScale(hourParser(data.TIME));
							},
							"x2":function(d){
								return xScale(hourParser(data.TIME));
							},
							"y1": 600,
							"y2":function(d){
								return yScale(+data.AQI);
							}
						})
						.attr("class","indicator indicator-y");

			}

			function dotLeave(data){
				svgHour.selectAll(".indicator").remove();
			}
			// click on dots to display air details
			function dotClick(data){

				so2Slider.select(".slider-indicator")
						.transition()
						.attr("transform", "translate("+slider_so2(+data.SO2_24h)+",-5)")


				no2Slider.select(".slider-indicator")
						.transition()
						.attr("transform", "translate("+slider_no2(+data.NO_24h)+",-5)")

				pm10Slider.select(".slider-indicator")
						.transition()
						.attr("transform", "translate("+slider_pm10(+data.pm10_24h)+",-5)")

				coSlider.select(".slider-indicator")
						.transition()
						.attr("transform", "translate("+slider_co(+data.CO_24h)+",-5)")

				o3Slider.select(".slider-indicator")
						.transition()
						.attr("transform", "translate("+slider_o3(+data.O3)+",-5)")

				pm25Slider.select(".slider-indicator")
						.transition()
						.attr("transform", "translate("+slider_pm25(+data["PM2.5_24h"])+",-5)")

			}





		})
	};

</script>
</body>
</html>
