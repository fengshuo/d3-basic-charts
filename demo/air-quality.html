<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title>Calender View</title>
	<style>
	body{
		padding-bottom: 100px;
	}

	.line{
		fill:none;
		stroke: orange;
		stroke-width: 1.5px;
	}

	.axis path,
	.axis line{
		fill:none;
		stroke:#000;
	}
	</style>
	<script src="../lib/d3.js"></script>
</head>
<body>
<script>

	window.onload = function(){
		// initiate settings
		var margin = {
			top:20,
			right:20,
			bottom:20,
			left:30
		};

		var width = 1150 - margin.left - margin.right;
		var height = 300 - margin.top - margin.bottom;
		var cellSize = 17;


		var svg = d3.select("body").append("svg")
				.attr({
					"width": width,
					"height": height
				})
				.append("g")
				.attr("transform", "translate("+ margin.left + "," + margin.top + ")");

		/* time formatter */
		var day = d3.time.format("%w");
		var week = d3.time.format("%U");
		var format = d3.time.format("%Y-%m-%d");
		var year = d3.time.format("%Y"); //to differentiate 2014,2015, avoid overlap
		var hourParser = d3.time.format("%H:%M:%S").parse;

		/**
		 *  color scale, uneven distribution
		 *  according to official document about AQI, the domain range is 0-500
		 */
		var colorScale = d3.scale.quantile()
		.domain([0,50,100,150,200,300,400,500])
		.range(['#00E400','#FFFF00','#FF7E00','#FF0000','#99004C','#7E0023','#65001c','#4b0015'])

    // meanings for each color:
		// http://en.wikipedia.org/wiki/Air_quality_index#Mainland_China

		d3.csv("../data/airquality.csv", function(err,csv){

			var data = d3.nest()
					.key(function(d){
						return d.DATE;
					})
					.entries(csv);

			data.forEach(function(d){

				var sum = 0;
				d.values.forEach(function(v){
					sum += Number(v.AQI);
				});
				d.average = Math.round(sum / d.values.length);
				d.max = d3.max(d.values, function(v){
					return +v.AQI;
				})
				d.min = d3.min(d.values, function(v){
					return +v.AQI;
				})
				d.key = format.parse(d.key)
			});


			/**
			 * calender view
			 */
			var rect = svg.selectAll(".day")
					.data(data)
					.enter()
					.append("rect")
					.attr("class","day")
					.attr({
						"width": cellSize,
						"height": cellSize,
						"x": function(d){

							if(year(d.key) == "2014"){
								return (week(d.key) - week(new Date(2014,3,13))) * cellSize;
							}else {
								return ( (52 - week(new Date(2014,3,13))) + Number(week(d.key)) ) * cellSize;
							}
						},
						"y": function(d){
							return day(d.key) * cellSize;
						}
					})
					.style("fill", function(d){
						return colorScale(d.average);
					})
					.on("click", showHour);

			rect.append("title")
			.text(function(d){
				return format(d.key) + " is " +  d.average;
			})


			/**
			 * show hourly data in line chart
			 */
			var minorMargin = {
				top:10,
				right:10,
				bottom:50,
				left:50
			}
			var minorWidth = 960 - minorMargin.left - minorMargin.right;
			var minorHight = 500 - minorMargin.top - minorMargin.bottom;

			var lineChart = d3.select("body").append("svg")
											.attr({
												"width": minorWidth,
												"height": minorHight
											})
											.append("g")
											.attr("transform","translate("+minorMargin.left+",0)")
											.attr("class","lineChart")

			// initialize lineChart
			var xScale = d3.time.scale()
								.domain([hourParser("00:00:00"),hourParser("23:00:00")])
								.range([0,minorWidth]);

			var yScale = d3.scale.linear()
									.range([minorHight-30, 0]);

			var xAxis = d3.svg.axis()
									.scale(xScale)
									.orient("bottom")

			var yAxis = d3.svg.axis()
									.scale(yScale)
									.orient("left")
			// line generator
			var lineGenerator = d3.svg.line()
			.interpolate("basis")
						.x(function(d){
							return xScale(hourParser(d.TIME))
						})
						.y(function(d){
							return yScale(Number(d.AQI))
						});

			// draw first time point
			yScale.domain([+data[0]["min"], +data[0]["max"]])

			var line = lineChart.selectAll(".line") //?
								.data([data[0]])
								.enter()
								.append("path")
								.attr("d", function(d){
									return lineGenerator(d.values);
								})
								.attr("class","line");

			var xLineAxis = lineChart.append("g")
				.attr("transform","translate(0," + (minorHight-30) + ")")
				.attr("class","x axis")
				.call(xAxis);

			var yLineAxis = lineChart.append("g")
									.attr("class","y axis")
									.call(yAxis);


			function showHour(d){
				yScale.domain([+d.min, +d.max]);
				line.transition()
					.duration(1000)
					.attr("d", function(d){
						return lineGenerator(d.values);
					})

			}





		})
	};

</script>
</body>
</html>
