<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title>Calender View</title>
	<style>
	body{
		padding-bottom: 100px;
	}

	.line{
		fill:none;
		stroke: orange;
		stroke-width: 1.5px;
	}

	.axis path,
	.axis line{
		fill:none;
		stroke:#000;
	}

	.dot {
		fill: none;
		stroke: steelblue;
		stroke-width: 2px;
	}

	.indicator{
		stroke: lightgrey;
		stroke-width: 3px;
	}

	.slider-indicator{
		stroke: black;
		stroke-width: 3px;
	}
	</style>
	<script src="../lib/d3.js"></script>
</head>
<body>
<script>

	window.onload = function(){
		// initiate settings
		var margin = {
			top:20,
			right:20,
			bottom:20,
			left:30
		};

		var width = 1150 - margin.left - margin.right;
		var height = 300 - margin.top - margin.bottom;
		var cellSize = 17;


		var svg = d3.select("body").append("svg")
				.attr({
					"width": width,
					"height": height
				})
				.append("g")
				.attr("transform", "translate("+ margin.left + "," + margin.top + ")");

		/* time formatter */
		var day = d3.time.format("%w");
		var week = d3.time.format("%U");
		var format = d3.time.format("%Y-%m-%d");
		var year = d3.time.format("%Y"); //to differentiate 2014,2015, avoid overlap
		var hourParser = d3.time.format("%H:%M:%S").parse;

		/**
		 *  color scale, uneven distribution
		 *  according to official document about AQI, the domain range is 0-500
		 */
		var colorScale = d3.scale.quantile()
		.domain([0,50,100,150,200,300,400,500])
		.range(['#00E400','#FFFF00','#FF7E00','#FF0000','#99004C','#7E0023','#65001c','#4b0015'])

    // meanings for each color:
		// http://en.wikipedia.org/wiki/Air_quality_index#Mainland_China

		d3.csv("../data/airquality.csv", function(err,csv){

			var data = d3.nest()
					.key(function(d){
						return d.DATE;
					})
					.entries(csv);

			data.forEach(function(d){

				var sum = 0;
				d.values.forEach(function(v){
					sum += Number(v.AQI);
				});
				d.average = Math.round(sum / d.values.length);
				d.max = d3.max(d.values, function(v){
					return +v.AQI;
				})
				d.min = d3.min(d.values, function(v){
					return +v.AQI;
				})
				d.key = format.parse(d.key)
			});

			/**
			 * calender view
			 */
			var rect = svg.selectAll(".day")
					.data(data)
					.enter()
					.append("rect")
					.attr("class","day")
					.attr({
						"width": cellSize,
						"height": cellSize,
						"x": function(d){

							if(year(d.key) == "2014"){
								return (week(d.key) - week(new Date(2014,3,13))) * cellSize;
							}else {
								return ( (52 - week(new Date(2014,3,13))) + Number(week(d.key)) ) * cellSize;
							}
						},
						"y": function(d){
							return day(d.key) * cellSize;
						}
					})
					.style("fill", function(d){
						return colorScale(d.average);
					})
					.on("click", showHour);

			rect.append("title")
			.text(function(d){
				return format(d.key) + " is " +  d.average;
			});


			// add legends for calender view
			svg.append("g")
					.attr("transform","translate(0,200)")
					.selectAll(".legend")
					.data(colorScale.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","legend")
					.style("fill", function(d,i){
						return d;
					})

			/**
			 * show hourly data in line chart
			 */
			var minorMargin = {
				top:50,
				right:10,
				bottom:50,
				left:50
			}
			var minorWidth = 960 - minorMargin.left - minorMargin.right;
			var minorHight = 500 - minorMargin.top - minorMargin.bottom;

			var lineChart = d3.select("body").append("svg")
											.attr({
												"width": minorWidth+minorMargin.left+minorMargin.right,
												"height": minorHight+minorMargin.top+minorMargin.bottom
											})
											.append("g")
											.attr("transform","translate("+minorMargin.left+",0)")
											.attr("class","lineChart")

			// initialize lineChart
			var xScale = d3.time.scale()
								.domain([hourParser("00:00:00"),hourParser("23:00:00")])
								.range([0,minorWidth]);

			var yScale = d3.scale.linear()
									.range([minorHight, 10]);

			var xAxis = d3.svg.axis()
									.scale(xScale)
									.orient("bottom")
									.tickFormat(d3.time.format("%H"))
									.ticks(24)

			var yAxis = d3.svg.axis()
									.scale(yScale)
									.orient("left")
					.ticks(9)
			// line generator
			var lineGenerator = d3.svg.line()
			// .interpolate("basis")
						.x(function(d){
							return xScale(hourParser(d.TIME))
						})
						.y(function(d){
							return yScale(Number(d.AQI))
						});


			// draw first time point as a line
			yScale.domain([+data[0]["min"], +data[0]["max"]]);


			var line = lineChart.append("path") // there is only one line
								.attr("d", lineGenerator(data[0].values))
								.attr("class","line");

			var xLineAxis = lineChart.append("g")
				.attr("transform","translate(0," + minorHight + ")")
				.attr("class","x axis")
				.call(xAxis);

			var yLineAxis = lineChart.append("g")
									.attr("class","y axis")
									.call(yAxis);


			// draw scatterplot chart with line
			// initialize first data point
			var dots = lineChart.selectAll(".dot")
					.data(data[0].values)
					.enter()
					.append("circle")
					.attr({
						"cx": function(d){
							return xScale(hourParser(d.TIME))
						},
						"cy": function(d){
							return yScale(+d.AQI);
						},
						"r": 5
					})
					.attr("class","dot")
					.on("mouseenter", dotEnter)
					.on("mouseleave", dotLeave)
					.on("click", dotClick);


			// add a chart for air detail
			// the standards for each substance are different from each other
			var sliderScale = d3.scale.linear()
														.range(d3.range(0, cellSize*9, cellSize));
			/**
			 *  scales for each substance
			 */
			// so2 average in last 24 hours
			var so2 = colorScale
					.domain([0,50,150,475,800,1600,2100,2620])
					.copy();

			var slider_so2 = sliderScale
											.domain([0,50,150,475,800,1600,2100,2620])
											.copy();

			// no2 average in last 24 hours
			var no2 = colorScale
					.domain([0,40,80,180,280,565,750,940])
					.copy();

			var slider_no2 = sliderScale
									.domain([0,40,80,180,280,565,750,940])
											.copy();
			// pm10 average in last 24 hours
			var pm10 = colorScale
					.domain([0,50,150,250,350,420,500,600])
					.copy();

			var slider_pm10 = sliderScale
									.domain([0,50,150,250,350,420,500,600])
											.copy();
			// co average in last 24 hours
			var co = colorScale
					.domain([0,2,4,14,24,36,48,60])
					.copy();
			var slider_co = sliderScale
									.domain([0,2,4,14,24,36,48,60])
											.copy();
			// o3 average in last 1 hour
			var o3 = colorScale
					.domain([0,160,200,300,400,800,1000,1200])
					.copy();
			var slider_o3 = sliderScale
									.domain([0,160,200,300,400,800,1000,1200])
											.copy();
			// pm2.5 in last 24 hours
			var pm25 = colorScale
					.domain([0,35,75,115,150,250,350,500])
					.copy();
			var slider_pm25 = sliderScale
									.domain([0,35,75,115,150,250,350,500])
											.copy();

			// add warpper for these sliders
			var sliderChart = d3.select("body").append("svg")
					.attr({
						"width": minorWidth+minorMargin.left+minorMargin.right,
						"height": minorHight+minorMargin.top+minorMargin.bottom
					})
					.append("g")
					.attr("transform","translate("+minorMargin.left+",0)")
					.attr("class","sliderChart");

			var so2Slider = sliderChart.append("g")
					.attr("transform","translate(0,30)")
					.attr("class","slider so2")

			var no2Slider = sliderChart.append("g")
					.attr("transform","translate(0,60)")
					.attr("class","slider no2")

			var pm10Slider = sliderChart.append("g")
					.attr("transform","translate(0,90)")
					.attr("class","slider pm10")

			var coSlider = sliderChart.append("g")
					.attr("transform","translate(0,120)")
					.attr("class","slider co")

			var o3Slider = sliderChart.append("g")
					.attr("transform","translate(0,150)")
					.attr("class","slider o3")

			var pm25Slider = sliderChart.append("g")
					.attr("transform","translate(0,180)")
					.attr("class","slider pm25")

			// add each slider, and initiate indicator of the slider
			// TODO:reuse?
			// so2
			so2Slider.selectAll(".slider-legend")
					.data(so2.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			so2Slider.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":25
					})
					.attr("class","slider-indicator");


			no2Slider.selectAll(".slider-legend")
					.data(no2.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			no2Slider.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":25
					})
					.attr("class","slider-indicator");

			pm10Slider.selectAll(".slider-legend")
					.data(pm10.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			pm10Slider.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":25
					})
					.attr("class","slider-indicator");



			coSlider.selectAll(".slider-legend")
					.data(co.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			coSlider.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":25
					})
					.attr("class","slider-indicator");

			o3Slider.selectAll(".slider-legend")
					.data(o3.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			o3Slider.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":25
					})
					.attr("class","slider-indicator");

			pm25Slider.selectAll(".slider-legend")
					.data(pm25.range())
					.enter()
					.append("rect")
					.attr({
						"x": function(d,i){
							return i * cellSize
						},
						"y": 0,
						"width":cellSize,
						"height":cellSize
					})
					.attr("class","slider-legend")
					.style("fill", function(d,i){
						return d;
					});

			pm25Slider.append("line")
					.attr({
						"x1":0,
						"y1":0,
						"x2":0,
						"y2":25
					})
					.attr("class","slider-indicator");


			/**
			 * event handlers
			 */

			function showHour(newData){
				console.log(newData)

				yScale.domain([+newData.min, +newData.max]);
				line.transition()
				.duration(1000)
					.attr("d", lineGenerator(newData.values));

				// no need for y axis transition in this case since the range is fixed
				// d3.select(".y.axis").call(yAxis)

				// dots transition
				var selectedHour = lineChart.selectAll(".dot")
						.data(newData.values);



						selectedHour.transition()
						.duration(1000)
						.delay(200)
						.attr({
							"cx": function(d){
								return xScale(hourParser(d.TIME))
							},
							"cy": function(d){
								return yScale(+d.AQI);
							}
						})


							selectedHour.exit().transition()
							.remove()



						selectedHour.enter()
						.append("circle")
						.attr("class","dot")

						



			};

			// hover on dots to toggle indication lines
			function dotEnter(data){
				lineChart.append("line")
						.attr({
							"x1":0,
							"x2":function(d){
								return xScale(hourParser(data.TIME));
							},
							"y1":function(d){
								return yScale(+data.AQI);
							},
							"y2":function(d){
								return yScale(+data.AQI);
							}
						})
						.attr("class","indicator indicator-x");

				lineChart.append("line")
						.attr({
							"x1":function(d){
								return xScale(hourParser(data.TIME));
							},
							"x2":function(d){
								return xScale(hourParser(data.TIME));
							},
							"y1": minorHight,
							"y2":function(d){
								return yScale(+data.AQI);
							}
						})
						.attr("class","indicator indicator-y");

			}

			function dotLeave(data){
				lineChart.selectAll(".indicator").remove();
			}
			// click on dots to display air details
			function dotClick(data){
				so2Slider.select(".slider-indicator")
						.transition()
						.attr("x1", slider_so2(+data.SO2_24h))
						.attr("x2", slider_so2(+data.SO2_24h))

				no2Slider.select(".slider-indicator")
						.transition()
						.attr("x1", slider_no2(+data.NO_24h))
						.attr("x2", slider_no2(+data.NO_24h))

				pm10Slider.select(".slider-indicator")
						.transition()
						.attr("x1", slider_pm10(+data.pm10_24h))
						.attr("x2", slider_pm10(+data.pm10_24h))

				coSlider.select(".slider-indicator")
						.transition()
						.attr("x1", slider_co(+data.CO_24h))
						.attr("x2", slider_co(+data.CO_24h))

				o3Slider.select(".slider-indicator")
						.transition()
						.attr("x1", slider_o3(+data.O3))
						.attr("x2", slider_o3(+data.O3))

				pm25Slider.select(".slider-indicator")
						.transition()
						.attr("x1", slider_pm25(+data["PM2.5_24h"]))
						.attr("x2", slider_pm25(+data["PM2.5_24h"]))
			}





		})
	};

</script>
</body>
</html>
